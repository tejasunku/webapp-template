# Architecture Resources - v0.0
# Local development environment configuration for client factory pattern validation

## Development Environment

### Local Development Setup
- **Method**: Local development with Node.js/Bun runtime
- **Purpose**: Validate client factory pattern and Shared Adapter Protocol
- **Scope**: Process and thread management without external dependencies
- **Runtime**: Bun (≥ 1.1) or Node.js (≥ 18)

### Package Management
- **Tool**: pnpm
- **Monorepo**: pnpm workspaces
- **Workspace Structure**: Apps, shared packages, documentation

## Development Tools

### Formal Verification Tools
- **Alloy Analyzer**: For static structural analysis of client factory
- **TLA+ Toolbox**: For temporal behavior analysis (if needed)
- **Purpose**: Validate client isolation and thread safety properties

### Runtime Environment
- **Process Management**: Native Node.js/Bun process handling
- **Thread Simulation**: Worker threads for concurrent access testing
- **Resource Monitoring**: Memory and process tracking for validation

## Simulated Resources

### Mock Service Adapters
- **Purpose**: Simulate external service clients for factory testing
- **Types**: Database client, Cache client, Queue client
- **Implementation**: Simple mock objects with state tracking
- **Isolation**: Each mock should be scoped per process/thread

### Test Process Simulation
- **Process ID Changes**: Simulated through PID manipulation
- **Thread ID Changes**: Worker thread creation/destruction
- **Client Lifecycle**: Creation, reuse, reinitialization tracking

## Environment Variables

### Development Configuration
```bash
# Development mode
NODE_ENV=development

# Client factory testing
CLIENT_FACTORY_TEST_MODE=true
MOCK_SERVICES_ENABLED=true

# Formal verification paths (if needed)
ALLOY_MODEL_PATH=docs/architecture/v0.0/alloy
TLA_MODEL_PATH=docs/architecture/v0.0/tla
```

## Resource Constraints (v0.0.0)

### What's Available
- Local process and thread management
- Mock service adapters for testing
- Formal verification tools (Alloy/TLA+)
- Basic file system and memory operations

### What's Not Available
- External database connections
- Network service calls
- Authentication systems
- Cache/storage services
- Production deployment resources

## Service Dependencies (v0.0.0)

```
Client Factory → Mock Service Adapters (local)
Formal Models → Alloy/TLA+ Analysis Tools (local)
Testing Framework → Process/Thread Simulation (local)
```

## Configuration Notes

### Client Factory Configuration
- No external service connections required
- Use mock adapters for all external dependencies
- Focus on process/thread isolation properties
- Validate client lifecycle management

### Formal Model Integration
- Alloy models for structural properties (client isolation)
- TLA+ models for temporal properties (if concurrent access needed)
- Models should be executable with local tools
- Results should inform milestone specifications

### Testing Strategy
- Unit tests for client factory behavior
- Integration tests for process/thread changes
- Formal model verification for mathematical properties
- Edge case testing for race conditions and resource management

## Development Environment

### Local Development
- **Method**: Docker Compose
- **Services**:
  - PostgreSQL container
  - Redis container
  - Application containers
- **Runtime**: Bun (≥ 1.1)

### Package Management
- **Tool**: pnpm
- **Monorepo**: pnpm workspaces
- **Bundling**: Vite for frontend, Bun for backend

## Environment Variables

### Required Variables
```bash
# Supabase
SUPABASE_URL=your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_KEY=your-service-key

# Render Redis
REDIS_URL=redis://your-redis-url
REDIS_HOST=your-redis-host
REDIS_PORT=6379
REDIS_PASSWORD=your-redis-password

# Application
NODE_ENV=development
PORT=3000

# AI (Future)
OPENROUTER_API_KEY=your-openrouter-key
```

## Configuration Notes

### Deployment
- All services use environment variables for config
- No hardcoded secrets or URLs
- Validate environment variables at startup with Valibot
- Use different .env files for different environments

### Redis Configuration
- Cache keys: `cache:*`
- Queue streams: `queue:*`
- Session storage: `session:*`
- Rate limiting: `ratelimit:*`

### Database Configuration
- Use connection pooling through Supabase
- Migrations via Drizzle Kit commands
- Schema changes should be backwards compatible
- Use TypeScript types generated by Drizzle

## Service Dependencies

```
ElysiaJS App → Supabase (Auth + DB + Storage)
ElysiaJS App → Redis (Cache + Queue)
Background Workers → Redis (Queue processing)
Frontend → ElysiaJS API
Frontend → Supabase Auth (direct)
```

## Future Resources

### Monitoring (Planned)
- **Provider**: Grafana Cloud
- **Stack**: Loki (logs), Prometheus (metrics), Tempo (traces)
- **Collector**: Grafana Alloy
- **Free Tier**: ~50GB logs, 14-day retention

### CI/CD
- **Platform**: GitHub Actions
- **Triggers**: Push to main, pull requests
- **Tests**: Vitunit, Playwright E2E

## Gotchas & Notes

- Render billing is per image, so bundle services when possible
- Redis on Render can handle both caching and queues via Streams
- Supabase edge functions are available but not using currently
- All external access should go through SDK adapters, not direct calls
- Environment variables must be validated at startup
- Use pnpm workspaces for monorepo package management